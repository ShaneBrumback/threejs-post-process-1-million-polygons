import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls.js";import{EffectComposer}from"three/examples/jsm/postprocessing/EffectComposer.js";import{RenderPass}from"three/examples/jsm/postprocessing/RenderPass.js";import{UnrealBloomPass}from"three/examples/jsm/postprocessing/UnrealBloomPass.js";let scene,camera,renderer,controls,manager,sound,stats,analyser,composer,bloomPass,meshCube,cubeLight,gui,guiElement,mouseX=0,mouseY=0,windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2;const params={exposure:1,bloomStrength:.5,bloomThreshold:1.5,bloomRadius:.15};function playNow(){document.getElementById("divPlayButton").style.display="none";const e=new THREE.AudioListener;camera.add(e),sound=new THREE.PositionalAudio(e),(new THREE.AudioLoader).load("./assets/game-changer.mp3",(function(e){sound.setBuffer(e),sound.setLoop(!0),sound.setRefDistance(100),sound.play()})),analyser=new THREE.AudioAnalyser(sound,128),meshCube.add(sound)}function init(){scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(100,window.innerWidth/window.innerHeight,1,4e3),renderer=new THREE.WebGLRenderer,renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.toneMapping=THREE.ReinhardToneMapping,document.body.appendChild(renderer.domElement),new THREE.BoxGeometry,new THREE.MeshBasicMaterial({color:65280}),controls=new OrbitControls(camera,renderer.domElement),camera.position.set(604,-337,316),camera.updateProjectionMatrix(),controls.update(),guiElement=document.getElementById("divGui"),bloomPass=new UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,.4,.85),bloomPass.threshold=params.bloomThreshold,bloomPass.strength=params.bloomStrength,bloomPass.radius=params.bloomRadius;const e=new RenderPass(scene,camera);composer=new EffectComposer(renderer),composer.addPass(e),composer.addPass(bloomPass),composer.renderToScreen=!0,loadCube(),cubeLight=new THREE.PointLight(16777215),cubeLight.position.set(0,0,0),scene.add(cubeLight);const n=new THREE.AmbientLight(4210752,1);n.position.set(0,300,0),scene.add(n);var o=new THREE.DirectionalLight(16777215);o.position.set(75,300,75),scene.add(o),window.addEventListener("pointermove",onPointerMove),document.getElementById("divPlayButton").addEventListener("pointerdown",playNow),window.addEventListener("resize",onWindowResize),animate()}function onPointerMove(e){!1!==e.isPrimary&&(mouseX=e.clientX-windowHalfX,mouseY=e.clientY-windowHalfY)}function getAverageFrequency(){try{let e=0;const n=analyser.getFrequencyData();for(let o=0;o<n.length;o++)e+=n[o];return e/n.length}catch(e){}}function onWindowResize(){windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2,camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),composer.setSize(window.innerWidth,window.innerHeight),renderer.setSize(window.innerWidth,window.innerHeight);try{window.innerWidth<=800?document.getElementById("divGui").style.display="none":document.getElementById("divGui").style.display="block"}catch(e){}}function animate(){requestAnimationFrame(animate),controls.update(),camera.position.x+=.05*(mouseX-camera.position.x),camera.position.y+=.05*(-mouseY-camera.position.y);const e=.001*Date.now();if(sound){let n=Math.round(getAverageFrequency()/2);bloomPass.threshold=n/100,renderer.toneMappingExposure=Math.pow(1+n/50,4)*Math.sin(.1*e),bloomPass.strength=.5,bloomPass.radius=n/200,document.getElementById("divRange").style.width=500*n/100+"px",document.getElementById("divRangeFooter").style.width=500*n/100+"px"}meshCube.rotation.x=.25*e,meshCube.rotation.y=.5*e,camera.lookAt(meshCube.position),camera.updateProjectionMatrix(),composer.render()}function loadCube(){const e=new THREE.BufferGeometry,n=[],o=[],t=[],r=new THREE.Color,s=800,i=12,a=new THREE.Vector3,d=new THREE.Vector3,m=new THREE.Vector3,l=new THREE.Vector3,c=new THREE.Vector3;for(let e=0;e<1e6;e++){const e=Math.random()*s-400,u=Math.random()*s-400,w=Math.random()*s-400,h=e+Math.random()*i-6,p=u+Math.random()*i-6,E=w+Math.random()*i-6,g=e+Math.random()*i-6,b=u+Math.random()*i-6,R=w+Math.random()*i-6,H=e+Math.random()*i-6,f=u+Math.random()*i-6,y=w+Math.random()*i-6;n.push(h,p,E),n.push(g,b,R),n.push(H,f,y),a.set(h,p,E),d.set(g,b,R),m.set(H,f,y),l.subVectors(m,d),c.subVectors(a,d),l.cross(c),l.normalize();const T=l.x,P=l.y,M=l.z;o.push(T,P,M),o.push(T,P,M),o.push(T,P,M);const B=e/s+.5,v=u/s+.5,C=w/s+.5;r.setRGB(B,v,C);const x=Math.random();t.push(r.r,r.g,r.b,x),t.push(r.r,r.g,r.b,x),t.push(r.r,r.g,r.b,x)}function u(){this.array=null}e.setAttribute("position",new THREE.Float32BufferAttribute(n,3).onUpload(u)),e.setAttribute("normal",new THREE.Float32BufferAttribute(o,3).onUpload(u)),e.setAttribute("color",new THREE.Float32BufferAttribute(t,4).onUpload(u)),e.computeBoundingSphere();const w=new THREE.MeshPhongMaterial({color:11184810,specular:16777215,shininess:250,side:THREE.DoubleSide,vertexColors:!0,transparent:!0});meshCube=new THREE.Mesh(e,w),meshCube.scale.set(.5,.5,.5),scene.add(meshCube),document.getElementById("divPlayButton").innerHTML='<i class="fas fa-play"></i>'}init();